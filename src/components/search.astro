---
import Layout from "../layouts/Layout.astro";

import BookCard from "../components/BookCard.astro";

import type { Book } from "../types/Book";

let results: Book[] = [];

const title = Astro.url.searchParams.get("title") ?? "";

if (title) {
  const res = await fetch(
    `${Astro.url.origin}/api/search-books?title=${encodeURIComponent(title)}`
  );

  const data = await res.json();
  results = data.books as Book[];
}
---

<Layout>
  <h1>Buscar libros</h1>

  <form method="GET">
    <input name="title" placeholder="Título del libro" value={title} />
    <button type="submit">Buscar</button>
  </form>
  {
    results.length > 0 && (
      <ul class="list">
        {results.map((book: Book) => (
          <li>
            <BookCard book={book}>
              <div class="buttons">
                <button class="button add" data-key={book.key}>
                  Añadir a biblioteca
                </button>

                <button class="button info" data-key={book.key} data-edition={book.edition_key?.[0]}>
                  Mostrar información
                </button>
              </div>

            </BookCard>
          </li>
        ))}
      </ul>
    )
  }
</Layout>

<script>

  function isInLibrary(key:string) {
    const stored = sessionStorage.getItem("biblioteca");
    const list = stored ? JSON.parse(stored) : [];
    return list.includes(key);
  }

  function addToLibrary(key:string) {
    const stored = sessionStorage.getItem("biblioteca");
    const list = stored ? JSON.parse(stored) : [];

    if (!list.includes(key)) {
      list.push(key);
      sessionStorage.setItem("biblioteca", JSON.stringify(list));
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // mostrar info general
    document.querySelectorAll(".add").forEach(el => {
      const btn = el;
      const key = btn.dataset.key;
      if (!key) return;

      // Si YA está en la biblioteca → cambiar el botón
      if (isInLibrary(key)) {
        btn.textContent = "Añadido ✓";
        btn.disabled = true;
        btn.classList.add("added");
      }

      // Evento click
      btn.addEventListener("click", () => {
        addToLibrary(key);

        btn.textContent = "Añadido ✓";
        btn.disabled = true;
        btn.classList.add("added");
      });
    });

    // mostrar info detalle
    document.querySelectorAll(".info").forEach(btn => {
      btn.addEventListener("click", async () => {
        


        const key = btn.dataset.key; // /works/OLxxxxW
        if (!key) return;

        const card = btn.closest(".card");
        if (!card) return;

        const infoDiv = card.querySelector(".detalle");
        if (!infoDiv) return;

        if(infoDiv.innerHTML.trim()==""){
          infoDiv.innerHTML = "<p>Cargando información...</p>";

          try {
            // 1. Obtener info de la obra
            const resWork = await fetch(`https://openlibrary.org${key}.json`);
            const work = await resWork.json();

            // 2. Obtener ediciones
            const resEditions = await fetch(`https://openlibrary.org${key}/editions.json?limit=50`);
            const editions = await resEditions.json();

            // Elegimos la primera edición que tenga páginas
            const editionWithPages = editions.entries.find(e => e.number_of_pages);

            const pages = editionWithPages?.number_of_pages ?? "No disponible";
            const publishDate = editionWithPages?.publish_date ?? "Desconocida";
            const publisher = editionWithPages?.publishers?.[0] ?? "Desconocida";

            infoDiv.innerHTML = `
              <p><strong>Descripción:</strong> ${
                shorten(
                  typeof work.description === "string"
                    ? work.description
                    : work.description?.value
                )

              }</p>

              <p><strong>Primera publicación:</strong> ${
                work.first_publish_date ?? "Desconocida"
              }</p>

              <p><strong>Número de páginas:</strong> ${pages}</p>

              <p><strong>Editorial:</strong> ${publisher}</p>

              <p><strong>Fecha de edición:</strong> ${publishDate}</p>
              `;
              btn.textContent="Ocultar información";
          } catch (error) {
            infoDiv.innerHTML = "<p>Error al cargar la información.</p>";
          }
        }else{
          infoDiv.innerHTML = "";
          btn.textContent="Mostrar información";

        }

        
      });
    });



  });

  function shorten(text:string, max = 150) {
    if (!text) return "Sin descripción";

    if (text.length <= max) return text;

    return text.slice(0, max) + "...";
  }

</script>

<style>
  .list {
    list-style: none;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
  }

  .buttons{
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
  }

  .button {
    padding: .45rem .8rem;
    border-radius: 6px;
    font-size: .85rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: background .2s ease;
    width: 75%;
  }

  .details {
    background: #e0e7ff;
    color: #1e3a8a;
    text-decoration: none;
  }

  .details:hover {
    background: #c7d2fe;
  }

  .add {
    background: #dcfce7;
    color: #166534;
  }

  .add:hover {
    background: #bbf7d0;
  }

  .info {
    background: #dce4fc;
    color: #164865;
  }

  .info:hover {
    background: #bbcbf7;
  }

  
</style>
