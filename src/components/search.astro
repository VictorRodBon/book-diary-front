---
import Layout from "../layouts/Layout.astro";

import BookCard from "../components/BookCard.astro";

import type { Book } from "../types/Book";

let results: Book[] = [];

const title = Astro.url.searchParams.get("title") ?? "";

if (title) {
  const res = await fetch(
    `${Astro.url.origin}/api/search-books?title=${encodeURIComponent(title)}`
  );

  const data = await res.json();
  results = data.books as Book[];
}
---

<Layout>
  <h1>Buscar libros</h1>

  <form method="GET">
    <input name="title" placeholder="Título del libro" value={title} />
    <button type="submit">Buscar</button>
  </form>
  {console.log(results)}
  {
    results.length > 0 && (
      <ul class="list">
        {results.map((book: Book) => (
          <li>
            <BookCard book={book}>
              <button class="button add" data-key={book.key}>
                Añadir a biblioteca
              </button>
            </BookCard>
          </li>
        ))}
      </ul>
    )
  }
</Layout>

<script>
  function isInLibrary(key) {
    const stored = sessionStorage.getItem("biblioteca");
    const list = stored ? JSON.parse(stored) : [];
    return list.includes(key);
  }

  function addToLibrary(key) {
    const stored = sessionStorage.getItem("biblioteca");
    const list = stored ? JSON.parse(stored) : [];

    if (!list.includes(key)) {
      list.push(key);
      sessionStorage.setItem("biblioteca", JSON.stringify(list));
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".add").forEach(el => {
      const btn = el;
      const key = btn.dataset.key;
      if (!key) return;

      // Si YA está en la biblioteca → cambiar el botón
      if (isInLibrary(key)) {
        btn.textContent = "Añadido ✓";
        btn.disabled = true;
        btn.classList.add("added");
      }

      // Evento click
      btn.addEventListener("click", () => {
        addToLibrary(key);

        btn.textContent = "Añadido ✓";
        btn.disabled = true;
        btn.classList.add("added");
      });
    });
  });
</script>

<style>
  .list {
    list-style: none;
    padding: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
  }

  .button {
    padding: .45rem .8rem;
    border-radius: 6px;
    font-size: .85rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: background .2s ease;
  }

  .details {
    background: #e0e7ff;
    color: #1e3a8a;
    text-decoration: none;
  }

  .details:hover {
    background: #c7d2fe;
  }

  .add {
    background: #dcfce7;
    color: #166534;
  }

  .add:hover {
    background: #bbf7d0;
  }
</style>
